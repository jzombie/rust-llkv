name: CodSpeed Bench (self-hosted mac d17-4)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  benches:
    # Only run this job for non-draft pull requests. We still want the job to run
    # for pushes and manual `workflow_dispatch` events. GitHub exposes
    # `github.event.pull_request.draft` (true for draft PRs), so require it to
    # be false when the event is a pull_request.
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}

    runs-on: [self-hosted, macOS, ARM64]

    steps:
      - uses: actions/checkout@v4

      # Ensure the mounted runner path exists and provide a no-space symlink
      # so subsequent steps can safely reference a path without spaces.
      - name: Ensure runner mount path and create symlink
        run: |
          TARGET='/Volumes/2TB Storage Vault/github-actions-runner'
          echo "Checking for runner target: $TARGET"
          if [ ! -d "$TARGET" ]; then
            echo "Target does not exist; creating directory (may be a placeholder until the volume is mounted)"
            mkdir -p "$TARGET"
          fi
          # Create an always-available, no-space symlink for scripts to use.
          ln -sfn "$TARGET" /opt/github-actions-runner || true
          echo "/opt/github-actions-runner -> $(readlink /opt/github-actions-runner)"
        shell: bash

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install CodSpeed CLI
        run: cargo install cargo-codspeed --locked

      - name: Build benches with CodSpeed
        run: cargo codspeed build

      - name: Run + upload to CodSpeed
        env:
          CODSPEED_TOKEN: ${{ secrets.CODSPEED_TOKEN }}
        run: cargo codspeed run
