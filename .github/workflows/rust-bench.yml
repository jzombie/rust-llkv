name: Continuous Benchmarking with Bencher

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# Grant the minimum permissions required for the action to create PR comments.
# By default GITHUB_TOKEN is read-only for many scopes; explicitly allow write
# access to issues/pull-requests so Bencher can post comments on PRs.
# Note: For runs triggered by forks, secrets (including GITHUB_TOKEN) are not
# available and commenting will fail â€” this is a GitHub security restriction.
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  benchmark_with_bencher:
    # Only run this job for non-draft pull requests. We still want the job to run
    # for pushes and manual `workflow_dispatch` events. GitHub exposes
    # `github.event.pull_request.draft` (true for draft PRs), so require it to
    # be false when the event is a pull_request.
    if: ${{ github.event_name != 'pull_request' || github.event.pull_request.draft == false }}
    name: Run Rust workspace benchmarks

    # runs-on: ubuntu-latest
    runs-on: [self-hosted, macOS, ARM64]
    env:
      BENCHER_PROJECT: llkv
      BENCHER_API_TOKEN: ${{ secrets.BENCHER_API_TOKEN }}
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: "${{ github.workspace }}/.sccache"
    steps:
      - uses: actions/checkout@v4

      - name: Cache Cargo registry and build target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
            ./.sccache
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install sccache
        run: |
          cargo install sccache --locked || true

      - uses: bencherdev/bencher@main
      - name: Run benches via Bencher
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false }}
        # Note: The `--github-actions` flag automatically creates a new comment on the PR
        # https://github.com/bencherdev/bencher?tab=readme-ov-file#comment-on-prs
        run: bencher run --github-actions "${{ secrets.GITHUB_TOKEN }}" "cargo bench"

      - name: Run benches via Bencher (from fork)
        if: ${{ github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == true }}
        run: bencher run "cargo bench"
